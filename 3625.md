[Problem: 3625. 统计梯形的数目 II](https://leetcode.cn/problems/count-number-of-trapezoids-ii/description/)

### 方法：组合数学

前一题是 [3621](https://leetcode.cn/problems/count-number-of-trapezoids-i/description/)，只要求两条边平行 $x$ 轴，相对来说更简单，题解为 [传送门](https://leetcode.cn/problems/count-number-of-trapezoids-i/solutions/3847027/san-jie-zhao-shui-ping-xian-duan-zu-he-s-mgcm/)。

在本题中，梯形任意，只要两条对边平行即可。注意，平行四边形是一种特殊的梯形。

根据数学知识可知，任意两点 $P_i, P_j$ 确定一条线段，同时也确定了一条直线，这条直线由 **斜率** 和 **截距** 唯一确定。同时，一个梯形也可以由两条对边线段唯一决定。

我们可以将所有点对 $(i, j)$ 进行连线，得到不同线段。将所有线段按 **斜率** 分组。只有斜率相同的线段才可能平行。在同一个斜率组内，再按 **截距** 分组。

- 对于同一个斜率，如果有两条不同的直线 $L_a$ 和 $L_b$。
- $L_a$ 上有 $N_a$ 个点，也就是有 $\binom{N_a}{2}$ 条线段。
- $L_b$ 上有 $N_b$ 个点，也就是有 $\binom{N_b}{2}$ 条线段。
- 从 $L_a$ 选一条线段，从 $L_b$ 选一条线段，这两条线段一定构成一个梯形。
- 对所有不同直线的组合进行累加，就得到梯形总数。

在上述计算中，**平行四边形** 会被计算两次。已知平行四边形有两组平行边，斜率 $k_1$ 的一对边，和斜率 $k_2$ 的一对边。在计算 $k_1$ 时被算了一次，计算 $k_2$ 时又被算了一次。因此，我们需要计算平行四边形的数量，并从总数中减去一次。

怎么判断平行四边形？两条线段不仅平行，而且 **长度相等**。因此，我们可以单独统计具有 `相同斜率 + 相同长度 + 不同直线` 的线段对数量，这就是平行四边形的数量 $\times 2$。

> $ps$：切记，最后的答案要除以 $2$，因为平行四边形是由两个线段对组成。

为什么前一题没有考虑平行四边形？因为当时的方法就不是计算斜率，直接按照平行于 $x$ 轴进行分组，两两组合即可（不会重复），不管是否为平行四边形。

**流程**：

1. 按斜率分组。对于每个斜率，我们有若干条平行的直线。梯形由两条不同直线上的线段组成。如果直线 $A$ 有 $a$ 条线段，直线 $B$ 有 $b$ 条线段，它们能组成 $a \times b$ 个梯形。累加所有不同直线对的乘积。
2. 去重。我们在每个斜率组内，进一步寻找 “长度相等且在不同直线上” 的线段对，这代表该斜率方向构成的平行四边形边对。利用 `总数 - 平行四边形数` 得到最终结果。

**数学计算**：

假设直线上两个点为 $(x1,y1),(x2,y2)$，可知斜率为

$$
\frac{dy}{dx}=\frac{y2-y1}{x2-x1}
$$

为了避免精度问题，使用整数对 $(dy,dx)$ 表示斜率，比如 $\frac{12}{8}$ 能表示为 $(3,2)$。具体编写代码时，使用 $GCD$ 保证是整数。另外，要规范化斜率方向，确保 $(dy,dx)$ 为 $(2,-4)$ 或者 $(-2,4)$ 是同一条直线。

同理，使用 “两点间距离公式” 求解线段长度会出现根号，使用长度的平方代替。

直线方程为 $dy*X - dx*Y + C = 0$，所以计算出斜率后，移项得到截距 $C$。

计算梯形时，我们采用两两直线组合的乘积之和，也即 $\sum_{i < j} (s_i \times s_j)$，其中 $s_i,s_j$ 是两条平行线段的长度，可以利用公式：

$$
2 * Sum = (SumAll)^2 - Sum(each^2)
$$

来加速计算。其中 $SumAll$ 是所有平行直线上的线段总数，而 $each$ 是每条直线的线段总数。

代码如下，已附加注释：

```Python
# python
class Solution:
    def countTrapezoids(self, points: List[List[int]]) -> int:
        n = len(points)
        # 存储：斜率 -> (直线截距 -> 该直线上所有线段的长度平方列表)
        lines_by_slope = defaultdict(lambda: defaultdict(list))
        
        # 构建线段信息
        for i in range(n):
            for j in range(i + 1, n):
                x1, y1 = points[i]
                x2, y2 = points[j]
                
                dy = y2 - y1
                dx = x2 - x1
                
                # 计算线段长度平方
                length_sq = dy**2 + dx**2
                
                # 化简斜率 (dy, dx)
                g = gcd(dy, dx)
                dy //= g
                dx //= g
                
                # 规范化斜率方向，确保 (1, -1) 和 (-1, 1) 被视为相同
                if dx < 0 or (dx == 0 and dy < 0):
                    dx = -dx
                    dy = -dy
                slope = (dy, dx)
                
                # 计算截距标识
                # 直线方程: dy*X - dx*Y + C = 0
                intercept_val = dx * y1 - dy * x1
                # 记录
                lines_by_slope[slope][intercept_val].append(length_sq)

        # 梯形/平行四边形总数
        total = 0
        para_cnt = 0

        # 在同一斜率下，从直线 A 选一个线段，从直线 B 选一个线段
        for slope, lines in lines_by_slope.items():
            line_segments_lists = list(lines.values())
            k = len(line_segments_lists)
            
            # 直线少于2条，无法构成梯形
            if k < 2:
                continue
            
            # 梯形总数，统计每条直线上线段的总数
            counts = [len(segments) for segments in line_segments_lists]
            # 两两直线组合的乘积之和
            sum_counts = sum(counts)
            sum_sq_counts = sum(c * c for c in counts)
            total += (sum_counts * sum_counts - sum_sq_counts) // 2

            # 平行四边形条件：斜率相同，且所在直线不同，且线段长度相等
            # 线段按长度分组
            len_map = defaultdict(list)
            
            for segments in line_segments_lists:
                # 当前直线上每种长度出现的次数
                cur_cnts = defaultdict(int)
                for length in segments:
                    cur_cnts[length] += 1
                
                # 记录到总表
                for length, count in cur_cnts.items():
                    len_map[length].append(count)
            
            # 对每种长度，计算来自不同直线的组合数
            for length, counts_list in len_map.items():
                if len(counts_list) < 2:
                    continue
                s_c = sum(counts_list)
                s_sq_c = sum(c * c for c in counts_list)
                para_cnt += (s_c * s_c - s_sq_c) // 2

        # 总对数 - 平行四边形数
        return total - para_cnt // 2
```

```Java
// java
import java.util.*;
class Solution {
    public int countTrapezoids(int[][] points) {
        int n = points.length;
        
        // 存储：斜率(String表示) -> (直线截距 -> 该直线上所有线段的长度平方列表)
        // 使用 String "dy_dx" 作为斜率的 Key
        Map<String, Map<Long, List<Long>>> linesBySlope = new HashMap<>();
        
        // 构建线段信息
        for (int i = 0; i < n; i++) {
            for (int j = i + 1; j < n; j++) {
                long x1 = points[i][0];
                long y1 = points[i][1];
                long x2 = points[j][0];
                long y2 = points[j][1];
                
                long dy = y2 - y1;
                long dx = x2 - x1;
                
                // 计算线段长度平方
                long lengthSq = dy * dy + dx * dx;
                
                // 化简斜率 (dy, dx)
                long g = gcd(Math.abs(dy), Math.abs(dx));
                dy /= g;
                dx /= g;
                
                // 规范化斜率方向，确保 (1, -1) 和 (-1, 1) 被视为相同
                if (dx < 0 || (dx == 0 && dy < 0)) {
                    dx = -dx;
                    dy = -dy;
                }
                String slope = dy + "_" + dx;
                
                // 计算截距标识
                // 直线方程: dy*X - dx*Y + C = 0 => C = dx*Y - dy*X
                long interceptVal = dx * y1 - dy * x1;
                
                // 记录
                linesBySlope.computeIfAbsent(slope, k -> new HashMap<>())
                            .computeIfAbsent(interceptVal, k -> new ArrayList<>())
                            .add(lengthSq);
            }
        }
        
        // 梯形/平行四边形总数
        long total = 0;
        long paraCnt = 0;
        
        // 在同一斜率下，从直线 A 选一个线段，从直线 B 选一个线段
        for (Map<Long, List<Long>> lines : linesBySlope.values()) {
            Collection<List<Long>> lineSegmentsLists = lines.values();
            int k = lineSegmentsLists.size();
            
            // 直线少于2条，无法构成梯形
            if (k < 2) {
                continue;
            }
            
            // 梯形总数，统计每条直线上线段的总数
            // 两两直线组合的乘积之和: (Sum^2 - Sum(sq)) / 2
            long sumCounts = 0;
            long sumSqCounts = 0;
            
            for (List<Long> segments : lineSegmentsLists) {
                long size = segments.size();
                sumCounts += size;
                sumSqCounts += size * size;
            }
            total += (sumCounts * sumCounts - sumSqCounts) / 2;
            
            // 平行四边形条件：斜率相同，且所在直线不同，且线段长度相等
            // 线段按长度分组
            Map<Long, List<Integer>> lenMap = new HashMap<>();
            
            for (List<Long> segments : lineSegmentsLists) {
                // 当前直线上每种长度出现的次数
                Map<Long, Integer> curCnts = new HashMap<>();
                for (long length : segments) {
                    curCnts.put(length, curCnts.getOrDefault(length, 0) + 1);
                }
                
                // 记录到总表
                for (Map.Entry<Long, Integer> entry : curCnts.entrySet()) {
                    lenMap.computeIfAbsent(entry.getKey(), key -> new ArrayList<>()).add(entry.getValue());
                }
            }
            
            // 对每种长度，计算来自不同直线的组合数
            for (List<Integer> countsList : lenMap.values()) {
                if (countsList.size() < 2) {
                    continue;
                }
                long sC = 0;
                long sSqC = 0;
                for (int c : countsList) {
                    sC += c;
                    sSqC += (long) c * c;
                }
                paraCnt += (sC * sC - sSqC) / 2;
            }
        }
        
        // 总对数 - 平行四边形数
        return (int) (total - paraCnt / 2);
    }
    
    private long gcd(long a, long b) {
        return b == 0 ? a : gcd(b, a % b);
    }
}
```

- 时间复杂度： $O(n^2)$，其中 $n$ 是数组 $points$ 的长度，总流程是遍历线段，两两组合
- 空间复杂度： $O(n^2)$，表示 $linesBySlope$ 等的大小

如果本篇题解你觉得写得不错，欢迎点个赞让更多人看见~

> 题解已发布力扣平台 [我的题解](https://leetcode.cn/problems/count-number-of-trapezoids-ii/solutions/3847901/shu-xue-ping-xing-zhi-xian-liang-liang-z-4gwd/)
